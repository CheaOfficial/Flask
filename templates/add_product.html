<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'head.html' %}
    <style>
        .container {
            display: flex;
            flex-wrap: wrap;
        }
        .table-container, .form-container {
            flex: 1;
            padding: 20px;
        }
        {#.table-container {#}
        {#    max-width: 50%;#}
        {#}#}
        {#.form-container {#}
        {#    max-width: 50%;#}
        {#}#}
        .table-responsive {
            max-height: 600px; /* or whatever height you prefer */
            overflow-y: auto;
        }
        img {
            max-width: 100px;
            max-height: 100px;
        }
    </style>
</head>
<body>
    {% include 'navbar.html' %}

    <div class="container">
        <div class="row">
            <div class="table-container">
                <div class="card-header">
                    <h1>Table Product</h1>
                </div>
                <div class="card-body">
                    <div class="table-responsive">

                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Cost</th>
                                <th>Price</th>
                                <th>Description</th>
                                <th>Image</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in product %}
                            <tr>
                                <td>{{ item.id }}</td>
                                <td>{{ item.title }}</td>
                                <td>{{ item.cost }}</td>
                                <td>{{ item.price }}</td>
                                <td>{{ item.description }}</td>

                                <td>
                                    <img src="static/uploads/{{ item.image }}" alt="{{ item.title }}">
                                </td>

                                <td>
                                    <a href="#" class="btn btn-warning edit-btn" data-id="{{ item.id }}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                                          <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001"/>
                                        </svg></a>
                                    <a href="#" class="btn btn-danger delete-btn" data-id="{{ item.id }}" style="background-color: #ff0000">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                          <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5M8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5m3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0"/>
                                        </svg>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>

            <div class="form-container">
                <div class="card-header">
                    <h1>Add New Product</h1>
                </div>
                <div class="card-body">
                    <form action="/submit_add_product" method="post" enctype="multipart/form-data">
                        <input type="hidden" id="product_id" name="product_id" value="123123">

                        <div class="cropper-container">
                            <img id="image-preview" src="#" alt="Image Preview" style="display: none;"/>
                            <label for="file">Image:</label>
                            <input class="form-control" type="file" id="file" name="file" accept="image/png, image/jpeg" required onchange="previewImage(event)">
                        </div>
                        <div>
                            <label for="title">Title:</label>
                            <input class="form-control" type="text" id="title" name="title">
                        </div>
                        <div class="form-group">
                            <label for="category">Category:</label>
                            <select class="form-control form-select" name="category" id="category">
                                {% for item in product %}
                                    <option value="{{ item.category }}">{{ item.category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="price">Price:</label>
                            <input class="form-control" type="number" id="price" name="price">
                        </div>
                        <div>
                            <label for="description">Description:</label>
                            <textarea class="form-control" id="description" name="description" rows="4"></textarea>
                        </div>
                        <button class="btn btn-primary" type="submit">Add Product</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

        <!-- Modal for Editing Product -->
    <div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-labelledby="editProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProductModalLabel">Edit Product</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="editProductForm" action="/edit_product" method="post" enctype="multipart/form-data">
                    <div class="modal-body">
                        <input type="hidden" id="edit_product_id" name="edit_product_id">

                        <div class="form-group">
                            <label for="current_picture">Current Picture:</label><br>
                            <img id="current_picture" src="#" alt="Current Picture" style="max-width: 200px; max-height: 200px;">
                            <input type="file" class="form-control-file" id="edit_picture" name="edit_picture" accept="image/png, image/jpeg" onchange="previewEditImage(event)">
                            <button type="button" class="btn btn-secondary mt-2" id="btn-crop">Crop Image</button>
                        </div>

                        <div>
                            <label for="edit_title">Title:</label>
                            <input class="form-control" type="text" id="edit_title" name="edit_title">
                        </div>
                        <div class="form-group">
                            <label for="edit_category">Category:</label>
                            <select class="form-control" name="edit_category" id="edit_category">
                                {% for item in product %}
                                    <option value="{{ item.category }}">{{ item.category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="edit_price">Price:</label>
                            <input class="form-control" type="number" id="edit_price" name="edit_price">
                        </div>
                        <div>
                            <label for="edit_description">Description:</label>
                            <textarea class="form-control" id="edit_description" name="edit_description" rows="4"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Modal for Delete Confirmation -->
    <div class="modal fade" id="deleteProductModal" tabindex="-1" role="dialog" aria-labelledby="deleteProductModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteProductModalLabel">Delete Product</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this product?
                </div>
                <div class="modal-footer">
                    <form id="deleteProductForm" action="/delete_product" method="post">
                        <input type="hidden" id="delete_product_id" name="delete_product_id">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Embed the product data in a JavaScript variable
        let products = {{ product|tojson }};

        // Script to handle modal for editing
        $(document).ready(function() {
            $('.edit-btn').click(function(e) {
                e.preventDefault();
                let productId = $(this).data('id');
                let product = products.find(item => item.id === productId);

                if (product) {
                    $('#edit_product_id').val(product.id);
                    $('#edit_title').val(product.title);
                    $('#edit_category').val(product.category);
                    $('#edit_price').val(product.price);
                    $('#edit_description').val(product.description);

                    $('#current_picture').attr('src', 'static/uploads/' + product.image);

                    $('#editProductModal').modal('show');
                    toggleCropButton();
                }
            });

            // Submit form on modal close (if needed)
            $('#editProductModal').on('hidden.bs.modal', function () {
                $('#editProductForm').submit();
            });

            // Script to handle modal for deleting
            $('.delete-btn').click(function(e) {
                e.preventDefault();
                let productId = $(this).data('id');
                $('#delete_product_id').val(productId);
                $('#deleteProductModal').modal('show');
            });

            // Redirect to cropping page with current image
            $('#btn-crop').click(function() {
                {#const imageUrl = $('#current_picture').attr('src');#}
                const currentPictureSrc = document.getElementById('current_picture').src;

                {#window.location.href = `/crop_image?image=${encodeURIComponent(imageUrl)}`;#}
                window.location.href = `/crop_image?image=${encodeURIComponent(currentPictureSrc)}`;
            });
        });

        // Script to preview image before uploading
        function previewImage(event) {
            const reader = new FileReader();
            reader.onload = function(){
                const output = document.getElementById('image-preview');
                output.src = reader.result;
                output.style.display = 'block';
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        function previewEditImage(event){
            const readerEdit = new FileReader();
            readerEdit.onload = function(){
                const outputEdit = document.getElementById('current_picture');
                outputEdit.src = readerEdit.result;
                outputEdit.style.display = 'block';
                toggleCropButton();
            };
            readerEdit.readAsDataURL(event.target.files[0]);
        }

        function toggleCropButton() {
            const currentPictureSrc = document.getElementById('current_picture').src;
            const btnCrop = document.getElementById('btn-crop');
            btnCrop.disabled = !(currentPictureSrc && currentPictureSrc !== '#');
        }
    </script>
    <script>
        document.getElementById('btn-crop').addEventListener('click', () => {
            const editProductId = document.getElementById('edit_product_id').value;
            const pictureSrc = document.getElementById('current_picture').src;
            const originalFilename = pictureSrc.split('/').pop(); // Get the original filename

            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/crop_image';
            form.style.display = 'none';

            const inputId = document.createElement('input');
            inputId.type = 'hidden';
            inputId.name = 'product_id';
            inputId.value = editProductId;
            form.appendChild(inputId);

            const inputImage = document.createElement('input');
            inputImage.type = 'hidden';
            inputImage.name = 'image';
            inputImage.value = pictureSrc;
            form.appendChild(inputImage);

            const inputFilename = document.createElement('input');
            inputFilename.type = 'hidden';
            inputFilename.name = 'original_filename';
            inputFilename.value = originalFilename;
            form.appendChild(inputFilename);

            document.body.appendChild(form);
            form.submit();
        });
    </script>


{#    <script src="../static/js/customcropjs/cropscript1.js"></script>#}
</body>
</html>
